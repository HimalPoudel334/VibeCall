{% extends "base.html" %}

{% block title %}Video Call - VibeCall{% endblock %}

{% block content %}
<style>
    nav { display: none !important; }
</style>

<div class="h-screen w-screen bg-teal-900/90 flex flex-col">
    <!-- Main Video Area -->
    <div class="flex-1 relative overflow-hidden" style="min-height: 0;">
        <!-- Remote Video (other users) -->
        <div id="remoteVideos" class="w-full h-full grid gap-0.5 sm:gap-1 p-0.5 sm:p-1 overflow-auto" style="max-height: calc(100vh - 80px);">
            <!-- Remote videos will be placed here -->
        </div>

        <div id="localVideoContainer" class="absolute bottom-4 right-4 w-48 h-36 sm:w-56 sm:h-40 md:w-64 md:h-48 lg:w-72 lg:h-52 bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg z-10" style="max-height: 200px; max-width: 300px;">
            <video id="localVideo" class="w-full h-full object-cover" autoplay muted></video>
            <div class="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs sm:text-sm">You</div>
        </div>

        <!-- Users List Panel (initially hidden) -->
        <div id="usersListPanel" class="absolute top-20 right-4 bg-black/90 backdrop-blur-sm text-white p-4 rounded-lg w-80 hidden">
            <h3 class="text-teal-400 font-semibold mb-3 border-b border-teal-600 pb-2">Connected Users</h3>
            <div id="usersContent" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user1</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
            </div>
        </div>

        <!-- Users Message Panel (initially hidden) -->
        <div id="userMessagePanel" class="absolute space-y-3 top-20 right-4 bg-black/90 backdrop-blur-sm text-white p-4 rounded-lg w-80 hidden">
            <h3 class="text-teal-400 font-semibold mb-3 border-b border-teal-600 pb-2">Messages</h3>
            <div id="messageContent" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user1</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user2</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <input
                    type="text"
                    id="userMessageInput"
                    placeholder="Type a message..."
                    class="flex-1 px-3 py-1 rounded bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
                />
                <button
                    id="sendUserMessage"
                    class="text-teal-400 hover:text-teal-300 transition"
                    title="Send Message"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="py-4 flex items-center justify-center bg-teal-900/90" style="height: 80px;">
        <div class="flex items-center gap-2 sm:gap-3 md:gap-4 flex-wrap justify-center max-w-[90vw]">
            <button id="toggleMicBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Toggle Mic">
                <i id="micIcon" class="fa-solid fa-microphone text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="toggleVideoBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Toggle Video">
                <i id="videoIcon" class="fa-solid fa-video text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="flipCameraBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Flip Camera">
                <i class="fa-solid fa-camera-rotate text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="userMessageBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Messages">
                <i class="fa-solid fa-comment text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="usersListToggle" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-teal-600 hover:bg-teal-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Users List">
                <i class="fa-solid fa-users text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="endCallBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="End Call">
                <i class="fa-solid fa-phone text-xs sm:text-sm md:text-lg"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // Users list toggle functionality
    document.getElementById('usersListToggle').addEventListener('click', function() {
        const messagePanel = document.getElementById('userMessagePanel');
        const usersPanel = document.getElementById('usersListPanel');
        if (!messagePanel.classList.contains('hidden')) {
            messagePanel.classList.add('hidden');
        }
        usersPanel.classList.toggle('hidden');
    });

    document.getElementById('userMessageBtn').addEventListener('click', function() {
        const usersPanel = document.getElementById('usersListPanel');
        const messagePanel = document.getElementById('userMessagePanel');
        if (!usersPanel.classList.contains('hidden')) {
            usersPanel.classList.add('hidden');
        }
        messagePanel.classList.toggle('hidden');
    });

    // Control buttons (unchanged)
    document.getElementById('toggleMicBtn').addEventListener('click', function() {
        this.classList.toggle('bg-teal-600');
        const icon = this.querySelector('i');
        icon.className = this.classList.contains('bg-teal-600') 
            ? 'fa-solid fa-microphone-slash text-lg' 
            : 'fa-solid fa-microphone text-lg';
    });

    document.getElementById('toggleVideoBtn').addEventListener('click', function() {
        this.classList.toggle('bg-teal-600');
        const icon = this.querySelector('i');
        icon.className = this.classList.contains('bg-teal-600') 
            ? 'fa-solid fa-video-slash text-lg' 
            : 'fa-solid fa-video text-lg';
    });

    document.getElementById('flipCameraBtn').addEventListener('click', function() {
        this.classList.toggle('bg-teal-600');
    });

    function addRemoteVideo(userId, userName) {
        const remoteVideos = document.getElementById('remoteVideos');
        
        const videoContainer = document.createElement('div');
        videoContainer.id = `remote-video-${userId}`;
        videoContainer.className = 'relative bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500/50 w-full h-full';
        
        const videoElement = document.createElement('div');
        videoElement.className = 'w-full h-full object-cover bg-gray-700'; // Using div as placeholder
        
        // Placeholder with initials
        const placeholder = document.createElement('div');
        placeholder.className = 'absolute inset-0 flex items-center justify-center bg-gray-700';
        
        const initials = getUserInitials(userName);
        placeholder.innerHTML = `
            <div class="w-16 h-16 bg-teal-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg">
                ${initials}
            </div>
        `;
        
        // Username overlay
        const userNameElement = document.createElement('div');
        userNameElement.className = 'absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs sm:text-sm';
        userNameElement.textContent = userName;
        
        // Add elements
        videoContainer.appendChild(videoElement);
        videoContainer.appendChild(placeholder);
        videoContainer.appendChild(userNameElement);
        remoteVideos.appendChild(videoContainer);
        
        // Update layout
        updateVideoLayout(remoteVideos.children.length);
    }
    
    function getUserInitials(userName) {
        const names = userName.split(' ');
        if (names.length === 1) {
            return names[0].charAt(0).toUpperCase();
        }
        return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
    }
    
    function updateVideoLayout(videoCount) {
        const remoteVideos = document.getElementById('remoteVideos');
        const localVideoContainer = document.getElementById('localVideoContainer');
        const isMobile = window.innerWidth < 640; // Mobile breakpoint (Tailwind 'sm')
        
        // Completely reset all grid-related classes and styles
        remoteVideos.className = 'w-full h-full grid gap-0.5 sm:gap-1 p-0.5 sm:p-1 overflow-auto';
        remoteVideos.style.gridAutoRows = '';
        
        // Count actual remote videos (excluding local video if it's in the grid)
        const actualRemoteCount = remoteVideos.contains(localVideoContainer) ? videoCount - 1 : videoCount;
        
        // Handle local video placement (only on mobile if >2 remote users)
        if (actualRemoteCount > 2 && isMobile) {
            // Move local video into grid
            if (!remoteVideos.contains(localVideoContainer)) {
                localVideoContainer.className = 'relative bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg w-full h-full';
                localVideoContainer.style.maxHeight = '';
                localVideoContainer.style.maxWidth = '';
                remoteVideos.appendChild(localVideoContainer);
            }
            // Set equal row heights for mobile grid
            remoteVideos.style.gridAutoRows = '1fr';
        } else {
            // Return local video to absolute position
            if (remoteVideos.contains(localVideoContainer)) {
                remoteVideos.removeChild(localVideoContainer);
                localVideoContainer.className = 'absolute bottom-4 right-4 w-48 h-36 sm:w-56 sm:h-40 md:w-64 md:h-48 lg:w-72 lg:h-52 bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg z-10';
                localVideoContainer.style.maxHeight = '200px';
                localVideoContainer.style.maxWidth = '300px';
                document.querySelector('.flex-1').appendChild(localVideoContainer);
            }
        }

        // Adjust grid columns based on actual remote video count
        if (actualRemoteCount === 0) {
            remoteVideos.classList.add('grid-cols-1');
        } else if (actualRemoteCount === 1) {
            remoteVideos.classList.add('grid-cols-1');
        } else if (actualRemoteCount === 2) {
            remoteVideos.classList.add('grid-cols-1', 'sm:grid-cols-2');
        } else if (actualRemoteCount <= 4) {
            remoteVideos.classList.add('grid-cols-2', 'sm:grid-cols-2');
        } else {
            remoteVideos.classList.add('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-3');
        }
    }
    
    function removeRemoteVideo(userId) {
        const videoElement = document.getElementById(`remote-video-${userId}`);
        if (videoElement) {
            videoElement.remove();
            const remoteVideos = document.getElementById('remoteVideos');
            updateVideoLayout(remoteVideos.children.length);
        }
    }

    // Add resize event listener to update layout on window resize
    window.addEventListener('resize', () => {
        const remoteVideos = document.getElementById('remoteVideos');
        updateVideoLayout(remoteVideos.children.length);
    });

    // Initial layout update on load
    window.addEventListener('load', () => {
        const remoteVideos = document.getElementById('remoteVideos');
        updateVideoLayout(remoteVideos.children.length);
    });

    // Demo: Simulate adding remote users
    setTimeout(() => {
        addRemoteVideo('user1', 'User 1');
        addRemoteVideo('user2', 'User 2');
        addRemoteVideo('user3', 'User 3');
        addRemoteVideo('user4', 'User 4');
        
        // Update users list
        document.getElementById('usersContent').innerHTML = `
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>You</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>User 1</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>User 2</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>User 3</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>User 4</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>
        `;
    }, 1000);

    const sendUserMessageBtn = document.getElementById('sendUserMessage');
    sendUserMessageBtn.addEventListener('click', sendUserMessage);
    const messageInputField = document.getElementById('userMessageInput');
    messageInputField.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendUserMessage();
        }
    });

    function sendUserMessage(){
        const messageInput = document.getElementById('userMessageInput');
        const message = messageInput.value.trim();
        if (message) {
            const messageContent = document.getElementById('messageContent');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-center justify-between p-2 bg-gray-800 rounded';
            messageElement.innerHTML = `
                <span>You: ${message}</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            `;
            messageContent.appendChild(messageElement);
            messageInput.value = '';
            messageContent.scrollTop = messageContent.scrollHeight;
        }
    };


    const 
        iceServers = [
            { urls: 'stun:stun.l.google.com:19302' },
            {
            urls: '{{ turn_credentials.urls|tojson }}',
                username: '{{ turn_credentials.username }}',
            credential: '{{ turn_credentials.credential }}'
            }
        ]
    

    async function connect(userId) {
        const roomId = document.getElementById('roomId').value;
        const status = document.getElementById('status');
        

    }

</script>
{% endblock %}
