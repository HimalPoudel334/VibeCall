{% extends "base.html" %}

{% block title %}Video Call - VibeCall{% endblock %}

{% block content %}
<style>
    nav { display: none !important; }
</style>

<div class="h-screen w-screen bg-teal-900/90 flex flex-col">
    <!-- Main Video Area -->
    <div class="flex-1 relative overflow-hidden" style="min-height: 0;">
        <!-- Remote Video (other users) -->
        <div id="remoteVideos" class="w-full h-full grid gap-0.5 sm:gap-1 p-0.5 sm:p-1 overflow-auto" style="max-height: calc(100vh - 80px);">
            <!-- Remote videos will be placed here -->
        </div>

        <div id="localVideoContainer" class="absolute bottom-4 right-4 w-48 h-36 sm:w-56 sm:h-40 md:w-64 md:h-48 lg:w-72 lg:h-52 bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg z-10" style="max-height: 200px; max-width: 300px;">
            <video id="localVideo" class="w-full h-full object-cover" autoplay muted></video>
            <div class="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs sm:text-sm">You</div>
        </div>

        <!-- Users List Panel (initially hidden) -->
        <div id="usersListPanel" class="absolute top-20 right-4 bg-black/90 backdrop-blur-sm text-white p-4 rounded-lg w-80 hidden">
            <h3 class="text-teal-400 font-semibold mb-3 border-b border-teal-600 pb-2">Connected Users</h3>
            <div id="usersContent" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user1</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
            </div>
        </div>

        <!-- Users Message Panel (initially hidden) -->
        <div id="userMessagePanel" class="absolute space-y-3 top-20 right-4 bg-black/90 backdrop-blur-sm text-white p-4 rounded-lg w-80 hidden">
            <h3 class="text-teal-400 font-semibold mb-3 border-b border-teal-600 pb-2">Messages</h3>
            <div id="messageContent" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user1</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
                <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                    <span>user2</span>
                    <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <input
                    type="text"
                    id="userMessageInput"
                    placeholder="Type a message..."
                    class="flex-1 px-3 py-1 rounded bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
                />
                <button
                    id="sendUserMessage"
                    class="text-teal-400 hover:text-teal-300 transition"
                    title="Send Message"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="py-4 flex items-center justify-center bg-teal-900/90" style="height: 80px;">
        <div class="flex items-center gap-2 sm:gap-3 md:gap-4 flex-wrap justify-center max-w-[90vw]">
            <button id="toggleMicBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Toggle Mic">
                <i id="micIcon" class="fa-solid fa-microphone text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="toggleVideoBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Toggle Video">
                <i id="videoIcon" class="fa-solid fa-video text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="flipCameraBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Flip Camera">
                <i class="fa-solid fa-camera-rotate text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="userMessageBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-gray-600 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Messages">
                <i class="fa-solid fa-comment text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="usersListToggle" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-teal-600 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="Users List">
                <i class="fa-solid fa-users text-xs sm:text-sm md:text-lg"></i>
            </button>
            <button id="endCallBtn" class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-110" title="End Call">
                <i class="fa-solid fa-phone text-xs sm:text-sm md:text-lg"></i>
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    let ws = null;
    let peerConnections = {};
    let localStream = null;
    const remoteStreams = {};
    let cameraFacingMode = 'user';
    
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    toggleVideoBtn.addEventListener('click', async () => {
        const videoBtn   = toggleVideoBtn;
        const videoIcon  = document.getElementById('videoIcon');
        const localCont  = document.getElementById('localVideoContainer');
        const localVid   = document.getElementById('localVideo');
    
        if (!localStream) return;
    
        const videoTracks = localStream.getVideoTracks();
        const videoOn = videoTracks.length > 0 && videoTracks[0].readyState === 'live';
    
        if (videoOn) {                                   // ---- TURN OFF ----
            // Stop and remove video tracks
            videoTracks.forEach(t => { 
                t.stop(); 
                localStream.removeTrack(t); 
            });
    
            // Replace video sender with null (keeps the slot but removes track)
            for (const [remoteId, pc] of Object.entries(peerConnections)) {
                const senders = pc.getSenders();
                const videoSender = senders.find(s => s.track?.kind === 'video');
                
                if (videoSender) {
                    await videoSender.replaceTrack(null);
                }
            }
    
            localVid.srcObject = null;
            videoBtn.classList.add('bg-red-600');
            videoIcon.className = 'fa-solid fa-video-slash text-xs sm:text-sm md:text-lg';
    
            // Add local placeholder
            localCont.querySelector('.placeholder')?.remove();
            localCont.appendChild(createPlaceholder('You'));
    
            console.log('Video OFF');
            
        } else {                                          // ---- TURN ON ----
            try {
                const cam = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: cameraFacingMode } 
                });
                const vTrack = cam.getVideoTracks()[0];
                localStream.addTrack(vTrack);
    
                // Replace null sender with new video track
                for (const [remoteId, pc] of Object.entries(peerConnections)) {
                    const senders = pc.getSenders();
                    const videoSender = senders.find(s => s.track === null || s.track?.kind === 'video');
                    
                    if (videoSender) {
                        await videoSender.replaceTrack(vTrack);
                    } else {
                        // No sender exists, add new one
                        pc.addTrack(vTrack, localStream);
                    }
                }
    
                localVid.srcObject = localStream;
                if (cameraFacingMode === 'user') {
                    localVid.style.transform = 'scaleX(-1)';
                }
                await localVid.play();
    
                videoBtn.classList.remove('bg-red-600');
                videoIcon.className = 'fa-solid fa-video text-xs sm:text-sm md:text-lg';
    
                // Remove local placeholder
                localCont.querySelector('.placeholder')?.remove();
    
                console.log('Video ON');
            } catch (e) {
                console.error('Camera failed', e);
                alert('Camera error: ' + e.message);
            }
        }
    });
    
    document.getElementById('flipCameraBtn').addEventListener('click', function () {
        this.classList.toggle('bg-teal-600');
    });
    
    document.getElementById('endCallBtn').addEventListener('click', leave);
    
    function createPlaceholder(name) {
        const div = document.createElement('div');
        div.className = 'placeholder absolute inset-0 flex items-center justify-center bg-gray-700';
        div.innerHTML = `<div class="w-16 h-16 bg-teal-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg">
                ${getUserInitials(name)}
                         </div>`;
        return div;
    }
    
    function getUserInitials(name) {
        if (!name || typeof name !== 'string') return '?';
        
        const trimmed = name.trim();
        if (!trimmed) return '?';

        if(trimmed == 'You') return 'You';
        
        const words = trimmed.split(/\s+/).filter(w => w.length > 0);
        
        if (words.length === 0) return '?';
        if (words.length === 1) return words[0][0].toUpperCase();
        
        return (words[0][0] + words[words.length - 1][0]).toUpperCase();
    }
    
    function addRemoteVideo(userId, userName, stream) {
        const vidId = `video-${userId}`;
        let videoEl = document.getElementById(vidId);
    
        if (!videoEl) {
            const remoteArea = document.getElementById('remoteVideos');
            const cont = document.createElement('div');
            cont.id = `remote-video-${userId}`;
            cont.className = 'relative bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500/50 w-full h-full';
            cont.dataset.userName = userName;
    
            videoEl = document.createElement('video');
            videoEl.id = vidId;
            videoEl.className = 'w-full h-full object-cover bg-gray-700';
            videoEl.autoplay = true;
            videoEl.playsInline = true;
    
            const nameEl = document.createElement('div');
            nameEl.className = 'absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs sm:text-sm';
            nameEl.textContent = userName;
    
            cont.append(videoEl, nameEl);
            remoteArea.appendChild(cont);
            updateVideoLayout(remoteArea.children.length);
        }
    
        if (videoEl.srcObject !== stream) {
            videoEl.srcObject = stream;
            videoEl.onloadedmetadata = () => videoEl.play().catch(e => {
                console.log('Auto-play prevented:', e);
            });
        }
    
        // Monitor the video element directly for video track activity
        const checkVideo = () => {
            setTimeout(() => updateRemotePlaceholder(userId, videoEl), 100);
        };
    
        videoEl.onplaying = checkVideo;
        videoEl.onpause = checkVideo;
        videoEl.onloadeddata = checkVideo;
    
        // Also monitor stream track changes
        stream.addEventListener('addtrack', e => {
            console.log('Track added:', e.track.kind, 'from user', userId);
            if (e.track.kind === 'video') {
                e.track.onmute = checkVideo;
                e.track.onunmute = checkVideo;
                e.track.onended = checkVideo;
                checkVideo();
            }
        });
        
        stream.addEventListener('removetrack', e => {
            console.log('Track removed:', e.track.kind, 'from user', userId);
            if (e.track.kind === 'video') {
                checkVideo();
            }
        });
    
        // Monitor existing tracks
        stream.getVideoTracks().forEach(track => {
            track.onmute = checkVideo;
            track.onunmute = checkVideo;
            track.onended = checkVideo;
        });
    
        // Initial check
        checkVideo();
    }
    
    function updateRemotePlaceholder(userId, videoElement) {
        const cont = document.getElementById(`remote-video-${userId}`);
        if (!cont) return;
    
        const stream = videoElement.srcObject;
        if (!stream) return;
    
        const videoTracks = stream.getVideoTracks();
        const hasActiveVideo = videoTracks.some(track => {
            return track.readyState === 'live' && track.enabled && !track.muted;
        });
        
        const ph = cont.querySelector('.placeholder');
    
        console.log('Placeholder check for user', userId, '- hasActiveVideo:', hasActiveVideo, 
                    'tracks:', videoTracks.length,
                    'track states:', videoTracks.map(t => ({ready: t.readyState, enabled: t.enabled, muted: t.muted})));
    
        if (!hasActiveVideo && !ph) {
            videoElement.style.display = 'none';
            const placeholder = createPlaceholder(cont.dataset.userName || `User ${userId}`);
            placeholder.classList.add('placeholder');
            cont.appendChild(placeholder);
            console.log('Added placeholder for user', userId);

        } else if (hasActiveVideo && ph) {
            videoElement.style.display = 'block';
            ph.remove();
            console.log('Removed placeholder for user', userId);

        } else if (!hasActiveVideo && ph) {
            videoElement.style.display = 'none';

        } else if (hasActiveVideo && !ph) {
            videoElement.style.display = 'block';
        }
    }
    
    async function renegotiate(pc, remoteId) {
        if (pc.signalingState !== 'stable') {
            console.log('Waiting for stable state before renegotiating...');
            return;
        }
    
        try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            sendMessage({
                type: 'offer',
                target_user_id: parseInt(remoteId),
                sdp: pc.localDescription.sdp
            });
            
            console.log('Offer sent to', remoteId);
        } catch (e) { 
            console.error('Renegotiate error for peer', remoteId, e); 
        }
    }
    
    async function applyAnswer(remoteId, sdp) {
        const pc = peerConnections[remoteId];
        if (pc && pc.signalingState === 'have-local-offer') {
            await pc.setRemoteDescription({ type: 'answer', sdp });
        }
    }
    
    function startConnection(userId, remoteId, label, isInitiator, iceServers) {
        const pc = new RTCPeerConnection({ iceServers });
        pc.remoteId = remoteId;
        peerConnections[remoteId] = pc;
    
        // Add current tracks (audio always, video if present)
        if (localStream) {
            localStream.getTracks().forEach(track => {
                console.log('Adding local track:', track.kind, 'to peer', remoteId);
                pc.addTrack(track, localStream);
            });
        }
    
        pc.ontrack = ev => {
            console.log('Received track:', ev.track.kind, 'from', remoteId, 'readyState:', ev.track.readyState);
            
            if (ev.streams && ev.streams[0]) {
                const stream = ev.streams[0];
                
                if (!remoteStreams[remoteId]) {
                    remoteStreams[remoteId] = stream;
                    addRemoteVideo(remoteId, label || `User ${remoteId}`, stream);
                } else {
                    // Stream already exists, update monitoring
                    const videoEl = document.getElementById(`video-${remoteId}`);
                    if (videoEl) {
                        // Track state changed, check placeholder
                        const checkVideo = () => {
                            setTimeout(() => updateRemotePlaceholder(remoteId, videoEl), 50);
                        };
                        
                        checkVideo();
                        
                        // Add listeners to new track
                        if (ev.track.kind === 'video') {
                            ev.track.onmute = () => {
                                console.log('New video track muted from', remoteId);
                                checkVideo();
                            };
                            ev.track.onunmute = () => {
                                console.log('New video track unmuted from', remoteId);
                                checkVideo();
                            };
                            ev.track.onended = () => {
                                console.log('New video track ended from', remoteId);
                                checkVideo();
                            };
                        }
                    }
                }
            }
        };
    
        pc.onicecandidate = ev => {
            if (ev.candidate) {
                sendMessage({
                    type: 'ice_candidate',
                    target_user_id: remoteId,
                    candidate: ev.candidate.candidate,
                    sdp_mid: ev.candidate.sdpMid,
                    sdp_m_line_index: ev.candidate.sdpMLineIndex
                });
            }
        };
    
        if (isInitiator) {
            setTimeout(() => {
                if (pc.signalingState === 'stable') {
                    renegotiate(pc, remoteId);
                }
            }, 0);
        }
        
        return pc;
    }
    
    async function handleOffer(userId, msg, iceServers) {
        const remoteId = msg.from ?? msg.user_id ?? msg.sender;
        const userName = msg.user_name || `User ${remoteId}`;
        if (!remoteId) return;
    
        if (peerConnections[remoteId]) {
            peerConnections[remoteId].close();
            delete peerConnections[remoteId];
            removeRemoteVideo(remoteId);
        }
    
        const pc = startConnection(userId, remoteId, userName, false, iceServers);
        try {
            await pc.setRemoteDescription({ type: 'offer', sdp: msg.sdp });
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
            sendMessage({ type: 'answer', target_user_id: remoteId, sdp: ans.sdp });
        } catch (e) { console.error('handleOffer', e); }
    }
    
    function updateVideoLayout(cnt) {
        const remoteArea = document.getElementById('remoteVideos');
        const localCont = document.getElementById('localVideoContainer');
        const mobile = window.innerWidth < 640;
    
        remoteArea.className = 'w-full h-full grid gap-0.5 sm:gap-1 p-0.5 sm:p-1 overflow-auto';
        remoteArea.style.gridAutoRows = '';
    
        const remoteCnt = remoteArea.contains(localCont) ? cnt - 1 : cnt;
    
        if (remoteCnt > 2 && mobile) {
            if (!remoteArea.contains(localCont)) {
                localCont.className = 'relative bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg w-full h-full';
                remoteArea.appendChild(localCont);
            }
            remoteArea.style.gridAutoRows = '1fr';
        } else {
            if (remoteArea.contains(localCont)) {
                remoteArea.removeChild(localCont);
                localCont.className = 'absolute bottom-4 right-4 w-48 h-36 sm:w-56 sm:h-40 md:w-64 md:h-48 lg:w-72 lg:h-52 bg-gray-800 rounded-lg overflow-hidden border-2 border-teal-500 shadow-lg z-10';
                document.querySelector('.flex-1').appendChild(localCont);
            }
        }
    
        const cols = remoteCnt === 0 ? 'grid-cols-1'
            : remoteCnt === 1 ? 'grid-cols-1'
            : remoteCnt === 2 ? 'grid-cols-1 sm:grid-cols-2'
            : remoteCnt <= 4 ? 'grid-cols-2 sm:grid-cols-2'
                : 'grid-cols-2 sm:grid-cols-2 lg:grid-cols-3';
        remoteArea.className += ' ' + cols;
    }
    
    function removeRemoteVideo(userId) {
        const el = document.getElementById(`remote-video-${userId}`);
        if (el) { el.remove(); updateVideoLayout(document.getElementById('remoteVideos').children.length); }
    }
    
    window.addEventListener('resize', () => updateVideoLayout(document.getElementById('remoteVideos').children.length));
    
    async function connect(userId) {
        try {
            const iceServers = {{ ice_servers | safe }};
            const roomId = '{{ room_id }}';
            const localVideo = document.getElementById('localVideo');
    
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: cameraFacingMode } });
    
            localVideo.srcObject = localStream;
            localVideo.muted = true;
            if (cameraFacingMode === 'user')
                localVideo.style.transform = 'scaleX(-1)';
    
            ws = new WebSocket(`https://himalpoudel.name.np/vibecall/call/ws/rooms/${roomId}`);
    
            ws.onopen = () => {
                sendMessage({ type: 'join', room_id: roomId, user_id: userId });
            };
    
            ws.onmessage = async e => {
                try {
                    const msg = JSON.parse(e.data);
                    await handleSignalingMessage(userId, msg, iceServers);
                } catch (_) { }
            };
    
            ws.onclose = () => cleanup();
            ws.onerror = e => console.error('WS error', e);
        } catch (e) {
            console.error('connect error', e);
            alert('Media / WS error: ' + e.message);
        }
    }
    
    async function handleSignalingMessage(userId, msg, iceServers) {
        switch (msg.type) {
            case 'user-joined':
                updateUsersList(msg.users);
                if (msg.user_id === userId) {
                    (msg.users || []).forEach(([rid, name]) => {
                        if (rid !== userId && !peerConnections[rid]) {
                            startConnection(userId, rid, name, true, iceServers);
                        }
                    });
                }
                break;
    
            case 'offer':
                await handleOffer(userId, msg, iceServers);
                break;
    
            case 'answer':
                await applyAnswer(msg.from ?? msg.user_id ?? msg.sender, msg.sdp);
                break;
    
            case 'ice-candidate':
                const pc = peerConnections[msg.from ?? msg.user_id ?? msg.sender];
                if (pc && msg.candidate) {
                    await pc.addIceCandidate({
                        candidate: msg.candidate,
                        sdpMid: msg.sdp_mid,
                        sdpMLineIndex: msg.sdp_m_line_index
                    }).catch(() => { });
                }
                break;
    
            case 'user-left':
                const uid = msg.user_id;
                if (peerConnections[uid]) {
                    peerConnections[uid].close();
                    delete peerConnections[uid];
                }
                removeRemoteVideo(uid);
                updateUsersList(msg.users);
                break;
    
            case 'error':
                alert('Server: ' + msg.message);
                break;
        }
    }
    
    function sendMessage(o) {
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(o));
    }
    
    function updateUsersList(users) {
        const me = parseInt('{{ user_id }}');
        const el = document.getElementById('usersContent');
        if (!users?.length) { el.textContent = 'None'; return; }
        el.innerHTML = users.map(([id, name]) => `
            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                <span>Person ${name} ${id === me ? '(You)' : ''}</span>
                <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
            </div>`).join('');
    }
    
    function leave() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            sendMessage({ type: 'leave', room_id: '{{ room_id }}' });
            ws.close();
        }
        cleanup();
    }
    
    function cleanup() {
        Object.values(peerConnections).forEach(pc => pc.close());
        peerConnections = {};
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        updateUsersList([]);
        const c = document.getElementById('controlsRow'); if (c) c.style.display = 'none';
        const j = document.getElementById('joinContainer'); if (j) j.style.display = 'block';
        window.location.href = "/vibecall";
    }
    
    window.addEventListener('load', () => {
        updateVideoLayout(0);
        connect(parseInt('{{ user_id }}'));
    });
    
    document.getElementById('sendUserMessage').addEventListener('click', sendUserMessage);
    document.getElementById('userMessageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendUserMessage(); }
    });
    
    function sendUserMessage() {
        const inp = document.getElementById('userMessageInput');
        const txt = inp.value.trim();
        if (!txt) return;
        const area = document.getElementById('messageContent');
        area.innerHTML += `<div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                              <span>You: ${txt}</span>
                              <div class="w-2 h-2 bg-teal-500 rounded-full"></div>
                           </div>`;
        inp.value = '';
        area.scrollTop = area.scrollHeight;
    }
    
    document.getElementById('toggleMicBtn').addEventListener('click', function () {
        if (!localStream) return;
        const t = localStream.getAudioTracks()[0];
        if (!t) return;
        t.enabled = !t.enabled;
        const ic = document.getElementById('micIcon');
        if (!t.enabled) {
            this.classList.add('bg-red-600');
            ic.className = 'fa-solid fa-microphone-slash text-xs sm:text-sm md:text-lg';
        } else {
            this.classList.remove('bg-red-600');
            ic.className = 'fa-solid fa-microphone text-xs sm:text-sm md:text-lg';
        }
    });
    
    document.getElementById('usersListToggle').addEventListener('click', function () {
        const msg = document.getElementById('userMessagePanel');
        const usr = document.getElementById('usersListPanel');
        if (!msg.classList.contains('hidden')) msg.classList.add('hidden');
        usr.classList.toggle('hidden');
        this.classList.toggle('bg-teal-600');
    });
    
    document.getElementById('userMessageBtn').addEventListener('click', function () {
        const usr = document.getElementById('usersListPanel');
        const msg = document.getElementById('userMessagePanel');
        if (!usr.classList.contains('hidden')) usr.classList.add('hidden');
        msg.classList.toggle('hidden');
    });

</script>
{% endblock %}
